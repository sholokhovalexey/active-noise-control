
### Active noise control
**Active noise control** ([ANC](https://en.wikipedia.org/wiki/Active_noise_control)) - is a method for reducing unwanted sound by the addition of a second sound generated by an ANC controller to cancel the first. The two sounds cancel each other out by an effect which is called *destructive interference*.

We consider a task of designing an ANC system for **headphones**.

<img src="images/earphone_anc.png" width="300">


According to the control structure, controllers can be categorized into the *feedforward* (FF) and *feedback* (FB) ones. The former one uses the signal from the reference microphone, while the latter one relies on the error signal coming from the error microphone. If an ANC system includes both controllers, it is usually called a *hybrid* system.

<img src="images/hybrid_anc.png" width="300">

The controller synthesis problem can be formulated as a constrained optimization problem. 
The controller is synthesized from a dataset of impulse responses of a headphone system.

#### Controller representation

Typically, ANC systems use a linear, time-invariant or adaptive, digital filter with a *finite impulse response* (FIR) or an *infinite impulse response* (IIR).

Compared to analog controllers, one problem of a digital controller is that an extra delay is introduced. Also, in the case of headphones, the distance between the reference microphone and the speaker does not exceed 1-1.5 cm. Both problems motivate using higher sampling frequency to reduce the latency, but it comes with the cost of increased computational burden, making the use of FIR based controllers impractical.

This problem could be alleviated with the usages of *warped FIR* filters or cascades of *biquad* filters (2nd order IIR), the latter of which is particularly advantageous for commercial products since the controller cost could be greatly lowered and the battery lifetime could also be lengthened.

The biggest advantage of an IIR based controller is its reduced computational complexity. Each biquad filter only needs 5 multiplications and 4 additions per sample to calculate its output, and the total number of multiplications or additions is less than 100. This is several orders of magnitude less than for FIR based controllers. 

Based on this reduced computational complexity, the sampling frequency could be greatly increased up to are 192 kHz or 384 kHz (typical values in commercial chips) so that a much smaller controller delay could be obtained. Consequently, a better noise reduction performance could be expected due to enhanced system causality.




#### ANC system structure

XXX general structure XXX

ERP - error reference point
DRP - drum reference point
PP - primary path
SP - secondary path
FF - feedforward controller
FB - feedback controller

Traditionally, an ANC system is tuned to produce optimum noise cancellation at the location of the error microphone, also called as the *error reference point* (ERP). This is because most of the ANC systems rely upon monitoring the cancelled signal to work. To maximize noise cancellation, an ideal placement of an error microphone would be at the eardrum. This point is often referred to as the *drum reference point* (DRP) . But that location is not practical or possible for many consumer devices. Thus, the ERP is used to provide a practical signal that is roughly indicative of the cancellation performance at the DRP, especially for lower frequencies (< 1 kHz). Also, sometimes it is considered acceptable to ignore any differences in noise cancellation between the ERP and the DRP.


++++++++++++++++++++++

Using [Mason's gain formula](https://en.wikipedia.org/wiki/Mason%27s_gain_formula), one can derive the transfer function:
$$ H = \frac{\sum_k P_k \Delta_k}{\Delta} $$
 that models the system's output $Y$ given the input $X$.


Graph determinant: $\Delta = 1 + FB \cdot SP_{ERP}$

Paths and co-factors: 
- $P_1 = G_{DRP}$, $\Delta_1 = 1 + FB \cdot SP_{ERP}$
- $P_2 = G_{REF} \cdot FF \cdot SP_{DRP}$, $\Delta_2 = 1$
- $P_3 = -G_{ERP} \cdot FB \cdot SP_{DRP}$, $\Delta_3 = 1$


Transfer function: 
$$
\begin{align}
H = \frac{Y}{X} = G_{DRP} + \frac{G_{REF} \cdot FF \cdot SP_{DRP} - G_{ERP} \cdot FB \cdot SP_{DRP}}{1 + FB \cdot SP_{ERP}} \\ 
= \frac{G_{DRP} + G_{REF} \cdot FF \cdot SP_{DRP} + G_{DRP} \cdot FB \cdot SP_{ERP} - G_{ERP} \cdot FB \cdot SP_{DRP}} {1 + FB \cdot SP_{ERP}} \\
= \frac{G_{DRP} + G_{REF} \cdot FF \cdot SP_{DRP} + FB \cdot (G_{DRP} \cdot SP_{ERP} - G_{ERP} \cdot SP_{DRP})} {1 + FB \cdot SP_{ERP}} \\
= \frac{G_{DRP} + G_{REF} \cdot FF \cdot SP_{DRP} + FB \cdot G_{DRP} \cdot SP_{ERP} \cdot (1 - \frac{G_{ERP} \cdot SP_{DRP}}{G_{DRP} \cdot SP_{ERP}})} {1 + FB \cdot SP_{ERP}} \\
\end{align}
$$


Introducing $PP_{ERP} = \frac{G_{ERP}}{G_{REF}}$, $PP_{DRP} = \frac{G_{DRP}}{G_{REF}}$ and $\Delta = \frac{G_{ERP} \cdot SP_{DRP}}{G_{DRP} \cdot SP_{ERP}} = \frac{PP_{ERP} \cdot SP_{DRP}}{PP_{DRP} \cdot SP_{ERP}}$, the transfer function can be rewritten as:
$$
\frac{Y}{G_{REF}X} = \frac{PP_{DRP} + FF \cdot SP_{DRP} + FB \cdot PP_{DRP} \cdot SP_{ERP} \cdot (1 - \Delta)} {1 + FB \cdot SP_{ERP}}
$$

Given this transfer function, one can can define the *sensitivity function* for a whole system - ratio of noise with ANC ON and ANC OFF:
$$
S = \frac{H}{G_{DRP}} = \frac{1 + \frac{SP_{DRP}}{PP_{DRP}} \cdot FF + FB \cdot SP_{ERP} \cdot (1 - \Delta)} {1 + FB \cdot SP_{ERP}}
$$

Let us assume that ${ERP} \equiv {DRP}$ for now. This simplifies the sensitivity function by eliminating ${FB}$ from the numerator:
$$
S = \frac{1 + \frac{SP_{ERP}}{PP_{ERP}} \cdot FF} {1 + FB \cdot SP_{ERP}}
$$
Under this assumption, design of a hybrid ANC controller, - minimization of the sensitivity function $S$ wrt to $FF$ and $FB$, - decouples into two independent optimization problems. Next sections present detailed discussion about the controller design.


### [Feedback] controller design

Let consider a feedback control system with linear time-invariant stable plant $P$, defined by its frequency response.

The objective is to synthesize a linear time-invariant controller $K$ that achieves good noise attenuation within the control bandwidth.
This can be achieved by minimizing the *sensitivity function*, *i.e.*, the *closed-loop* transfer function:
%% S = \frac{E}{D} = %%
$$ S = \frac{1}{1 + K \cdot P} = \frac{1}{1 + L} $$ 
It can also be represented in decibels by $\mathrm{RA}(\mathrm{dB}) = 20\log_{10}|S|$ to practically mean the *relative noise attenuation* after control.
Here, $L$ denotes the *open-loop* transfer function. 

In the case of feedback ANC, the plant is $P$ is given by the measured secondary path response.


#### Controller representation

In [] a method for designing an ANC controller represented as a FIR filter was proposed. The coefficients of the filter were found by solving a *convex optimization* problem. Despite convenience of the problem formulation and uniqueness of a solution, practical implementations of FIR controllers are usually restricted by their computational complexity. Therefore, IIR filters are usually preferred for implementing ANC controllers. Also, a cascade of 5-10 biquad filters can approximate a prescribed frequency response with reasonable accuracy, required for building a competitive ANC system. Here, cascades of biquad filters are used as the feedback and feedforward controllers, which is in accordance with the most commercial ANC headphones currently available on the market (2024). 

##### Filter parameterization

Instead of the general form represented with poles and zeros, several kinds of parametric biquad filters [with minimum phase frequency responses] are considered here. The corresponding transfer functions can be written as follows:

XXX


#### Stability constraints
According to the [Nyquist stability criterion](https://en.wikipedia.org/wiki/Nyquist_stability_criterion), a closed-loop system is stable iif the Nyquist curve of the open-loop transfer function does not encircle the point $-1+0i$. For ensuring this criterion we define forbidden regions in the complex plane.
In practice, it is not enough that a system is stable. There must be some margins of stability to describe its robustness to perturbation. There are several common stability measures defined as follows:
- **Stability margin** is a shortest distance from the Nyquist curve to the critical point $(-1, 0)$.
- **Gain margin** (GM) is a factor by which the gain of a stable system is allowed to increase before the system becomes unstable. It is the inverse of the distance between the origin and the point between $-1$ and $0$ where the Nyquist curve crosses the real axis.
- **Phase margin** (PM) is the amount of phase lag that a system can tolerate before becoming unstable. It is defined as the difference between $-180$ degrees and the phase angle of the open-loop transfer function at the frequency where the magnitude is $1$ ($0$ $\mathrm{dB}$).

The gain margin and phase margins on the Nyquist plot:
<img src="images/margins.jpg" width="300">

One of the ways to define a constraint is the following:
$$ |1 - L(\omega)| - |1+L(\omega)| \leq 2a, \forall \omega \in [0, \infty) $$
This inequality defines a hyperbolic bound in the complex plane. This bound not only prevents $L$ from encirclement of the point $(-1, 0)$, but also provides the following stability margins:

$$
\begin{equation}
\begin{cases} 
\mathrm{GM} \geq a^{-1}\\
\mathrm{PM} \geq \cos^{-1}(a\sqrt{2-a^2})
\end{cases}
\end{equation}
$$

Forbidden area (black) in the complex plane:
<img src="images/constraint_hyperbola.png" width="500">

%% +++++++++++++++++++++++++++++++++++++++++++ %%

Another similar constraint can be defined based on a parabola in the complex plane:
$$ \mathfrak{R}\{L(\omega)\} \geq -d_1 \mathfrak{I}\{L(\omega)\}^2 - d_2 $$

Forbidden area (black) in the complex plane:
<img src="images/constraint_parabola.png" width="500">

Finally, physical systems generally have some high frequency plant uncertainty. For instance, a slight change in the system delay could cause a large phase variation in the high-frequency band. Thus, the open-loop gain should be small enough above $\omega_{h}$:
$$ |L(\omega)| \leq c, \forall \omega \in [\omega_{h}, \infty) $$


#### Performance constraints

According to [Bode's sensitivity integral theorem](https://en.wikipedia.org/wiki/Bode%27s_sensitivity_integral), there is a fundamental trade-off, known as the *waterbed effect*, between decreasing (below unity) the magnitude of the sensitivity function in some frequency regions and getting it increased (above unity) at the other frequency regions. Therefore, to avoid excessive noise amplification ($|S|>1$), some constraint must be included to prevent the magnitude of the sensitivity function of growing too large.
$$ |1 + L(\omega)| \geq b, \forall \omega \in [0, \infty) $$
This constraint defines a circular region with a radius $b$ centered at $(-1, 0)$. This bound ensures that the magnitude of the sensitivity function is below $b^{-1}$ and provides the following stability margins:

$$
\begin{equation}
\begin{cases} 
\mathrm{GM} \geq (1 - b)^{-1}\\
\mathrm{PM} \geq \cos^{-1}(1 - b^2/2)
\end{cases}
\end{equation}
$$

In summary, given the frequency response of the plant (secondary path) ++++++++++++++++++++++++++++

Due to discretization, the number of frequency points used in the calculations should be large enough to ensure that the values of $L(\omega)$ between two frequency points are still outside the forbidden region.

#### --summary: optimization problem formulation and solver description--

xxx
The optimization problem described by Eq. (19) is non-convex since the controller has an IIR structure. 
xxx

### [Feedforward] controller design


### ANC controller design issues

#### Plant uncertainty
Multiplicative uncertainty model:

$S(\omega) = S_0(\omega)(1 + W(\omega) \cdot \Delta(\omega))$
Here, $\Delta$ is a subset of complex number that fulfills the condition $|\Delta(\omega)| \leq 1, \forall \omega$.

$W(\omega) = \max_i | \frac{S_i(\omega) - S_0(\omega)}{S_0(\omega)} |$

$S(\omega) = S_0(\omega)(1 + W(\omega) \cdot \Delta(\omega)) = S_0(\omega) + r\cdot\Delta(\omega)$

$r = S_0(\omega) \max_i | \frac{S_i(\omega) - S_0(\omega)}{S_0(\omega)} | \approx \max_i | S_i(\omega) - S_0(\omega) |$

#### ERP vs DRP

### References
